<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=yes">
    <title>Leitor de PDF com S√≠ntese de Voz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #888888;
            --border-color: #e0e0e0;
            --button-bg: #3b82f6;
            --button-hover: #2563eb;
            --button-secondary: #6b7280;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
            --reader-bg: #ffffff;
            --reader-text: #333333;
            --success-bg: #10b981;
            --error-bg: #ef4444;
            --warning-bg: #f59e0b;
            --selection-bg: rgba(59, 130, 246, 0.3);
            --overlay-bg: rgba(0, 0, 0, 0.8);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --button-bg: #3b82f6;
            --button-hover: #2563eb;
            --button-secondary: #475569;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-lg: rgba(0, 0, 0, 0.4);
            --reader-bg: #1e293b;
            --reader-text: #e2e8f0;
            --selection-bg: rgba(59, 130, 246, 0.4);
            --overlay-bg: rgba(0, 0, 0, 0.9);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        ::selection {
            background: var(--selection-bg);
            color: var(--text-primary);
        }

        /* Progress Bar */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: var(--button-bg);
            transition: width 0.3s ease;
            z-index: 1001;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            box-shadow: 0 2px 10px var(--shadow);
            z-index: 1000;
            position: relative;
            transition: transform 0.3s ease;
        }

        .header.fullscreen-hidden {
            transform: translateY(-100%);
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .header-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }

        .upload-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--button-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--button-bg);
            color: white;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            min-height: 36px;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .font-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
        }

        .font-size-display {
            font-weight: 600;
            min-width: 45px;
            text-align: center;
            font-size: 12px;
        }

        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        /* Floating Controls for Fullscreen */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--overlay-bg);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 8px;
            display: none;
            flex-direction: row;
            gap: 8px;
            z-index: 1002;
            box-shadow: 0 8px 32px var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .floating-controls.show {
            display: flex;
        }

        .floating-controls .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 44px;
            min-height: 44px;
            border-radius: 50%;
            padding: 8px;
        }

        .floating-controls .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Quick Access Panel */
        .quick-panel {
            position: fixed;
            top: 50%;
            left: -300px;
            transform: translateY(-50%);
            width: 280px;
            max-height: 80vh;
            background: var(--overlay-bg);
            backdrop-filter: blur(15px);
            border-radius: 0 15px 15px 0;
            padding: 20px;
            z-index: 1003;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 5px 0 25px var(--shadow-lg);
        }

        .quick-panel.show {
            left: 0;
        }

        .quick-panel h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .quick-panel .control-group {
            margin-bottom: 15px;
        }

        .quick-panel label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            font-weight: 500;
            display: block;
            margin-bottom: 5px;
        }

        .quick-panel .btn {
            width: 100%;
            margin-bottom: 8px;
            justify-content: flex-start;
        }

        /* TTS Controls */
        .tts-controls {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .tts-controls.hidden {
            display: none;
        }

        .tts-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .tts-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .slider {
            flex: 1;
            min-width: 60px;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--button-bg);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--button-bg);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .select {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            min-width: 120px;
            max-width: 200px;
        }

        .selected-text-preview {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 13px;
        }

        /* Main Content */
        .main-content {
            min-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
        }

        .main-content.fullscreen {
            min-height: 100vh;
            padding-top: 0;
        }

        .upload-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            margin: 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 300px;
        }

        .upload-area:hover {
            border-color: var(--button-bg);
            background: var(--bg-primary);
        }

        .upload-area.dragover {
            border-color: var(--button-bg);
            background: var(--button-bg);
            color: white;
            transform: scale(1.02);
        }

        .upload-text {
            text-align: center;
            font-size: 18px;
            color: var(--text-secondary);
            padding: 20px;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .reader-container {
            flex: 1;
            overflow-y: auto;
            background: var(--reader-bg);
            margin: 20px;
            border-radius: 12px;
            box-shadow: inset 0 2px 10px var(--shadow);
            display: none;
            position: relative;
            max-height: calc(100vh - 250px);
            transition: all 0.3s ease;
        }

        .reader-container.fullscreen {
            margin: 0;
            border-radius: 0;
            max-height: 100vh;
            height: 100vh;
        }

        .reader-content {
            width: 100%;
            margin: 0;
            padding: 40px 60px;
            line-height: 1.8;
            color: var(--reader-text);
            font-size: 16px;
            text-align: justify;
            word-wrap: break-word;
            transition: all 0.3s ease;
            min-height: 100%;
        }

        .reader-content.fullscreen {
            padding: 30px 40px;
            padding-bottom: 100px;
        }

        .reader-content h1,
        .reader-content h2,
        .reader-content h3 {
            margin: 30px 0 20px;
            color: var(--text-primary);
            line-height: 1.4;
            font-weight: bold;
        }

        .reader-content h2 {
            font-size: 1.5em;
        }

        .reader-content p {
            margin-bottom: 20px;
            text-indent: 1.5em;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            color: var(--text-secondary);
            margin-top: 50px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--button-bg);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .page-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--text-secondary);
            padding: 0 60px;
            transition: all 0.3s ease;
        }

        .page-info.fullscreen {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--overlay-bg);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .error-message {
            background: var(--error-bg);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
            animation: fadeIn 0.5s ease;
            z-index: 1004;
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Debug info for mobile */
        .debug-info {
            position: fixed;
            top: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1005;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--button-bg);
        }

        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-reading {
            background: var(--success-bg);
            animation: pulse 1.5s infinite;
        }

        .status-paused {
            background: var(--warning-bg);
        }

        .status-stopped {
            background: var(--text-muted);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }

            .header-content {
                gap: 12px;
            }

            .header-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .upload-container {
                min-width: auto;
            }

            .controls {
                justify-content: center;
                gap: 8px;
            }

            .font-controls {
                justify-content: center;
                gap: 6px;
                padding: 6px 10px;
            }

            .btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            .btn-small {
                padding: 6px 10px;
                font-size: 11px;
                min-height: 32px;
            }

            .reader-content {
                padding: 25px 20px;
                font-size: 15px;
                line-height: 1.7;
            }

            .reader-content.fullscreen {
                padding: 20px 15px;
                padding-bottom: 80px;
                font-size: 16px;
            }

            .upload-text {
                font-size: 16px;
                padding: 15px;
            }

            .upload-icon {
                font-size: 36px;
            }

            .upload-area {
                margin: 15px;
                min-height: 250px;
            }

            .reader-container {
                margin: 15px;
                max-height: calc(100vh - 220px);
            }

            .tts-controls {
                padding: 12px;
            }

            .tts-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .control-group {
                justify-content: space-between;
                flex-wrap: nowrap;
            }

            .slider-container {
                justify-content: space-between;
                min-width: auto;
            }

            .slider {
                min-width: 80px;
            }

            .select {
                min-width: 100px;
                font-size: 12px;
            }

            .floating-controls {
                bottom: 15px;
                right: 15px;
                flex-direction: column;
                padding: 6px;
            }

            .quick-panel {
                width: 260px;
                padding: 15px;
            }

            .page-info {
                padding: 0 20px;
                font-size: 14px;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 10px 12px;
            }

            .reader-content {
                padding: 20px 15px;
                font-size: 14px;
                text-indent: 0.8em;
            }

            .reader-content.fullscreen {
                padding: 15px 12px;
                padding-bottom: 70px;
                font-size: 15px;
            }

            .page-info {
                padding: 0 15px;
                font-size: 13px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .font-size-display {
                min-width: 35px;
                font-size: 11px;
            }

            .file-name {
                max-width: 120px;
                font-size: 12px;
            }

            .upload-area {
                margin: 12px;
                min-height: 200px;
            }

            .reader-container {
                margin: 12px;
            }

            .floating-controls {
                bottom: 12px;
                right: 12px;
            }

            .quick-panel {
                width: 240px;
                padding: 12px;
            }
        }

        /* Landscape orientation on mobile */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 6px 12px;
            }

            .header-content {
                gap: 8px;
            }

            .upload-area {
                min-height: 150px;
                margin: 8px;
            }

            .upload-icon {
                font-size: 24px;
                margin-bottom: 8px;
            }

            .upload-text {
                font-size: 14px;
                padding: 10px;
            }

            .reader-container {
                margin: 8px;
                max-height: calc(100vh - 140px);
            }

            .reader-content {
                padding: 15px 20px;
                line-height: 1.6;
            }

            .reader-content.fullscreen {
                padding: 10px 15px;
                padding-bottom: 60px;
            }

            .tts-controls {
                padding: 10px;
            }

            .floating-controls {
                bottom: 8px;
                right: 8px;
                padding: 4px;
            }

            .floating-controls .btn {
                min-width: 36px;
                min-height: 36px;
            }
        }

        /* Touch devices optimization */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            .btn-icon {
                width: 44px;
                height: 44px;
            }

            .slider::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }

            .floating-controls .btn {
                min-width: 48px;
                min-height: 48px;
            }
        }

        /* Very small screens */
        @media (max-width: 320px) {
            .reader-content {
                padding: 15px 10px;
            }

            .reader-content.fullscreen {
                padding: 10px 8px;
                padding-bottom: 60px;
            }

            .tts-controls {
                padding: 8px;
            }

            .header {
                padding: 8px 8px;
            }

            .upload-area {
                margin: 8px;
            }

            .quick-panel {
                width: 220px;
                padding: 10px;
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-small {
            font-size: 12px;
        }

        .font-bold {
            font-weight: bold;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        /* Fullscreen specific styles */
        .fullscreen-mode .header {
            transform: translateY(-100%);
        }

        .fullscreen-mode .main-content {
            min-height: 100vh;
        }

        .fullscreen-mode .reader-container {
            margin: 0;
            border-radius: 0;
            max-height: 100vh;
            height: 100vh;
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --button-bg: #0000ff;
                --text-primary: #000000;
            }

            [data-theme="dark"] {
                --border-color: #ffffff;
                --button-bg: #00ffff;
                --text-primary: #ffffff;
            }
        }
    </style>
</head>
<body>
    <div class="reading-progress" id="readingProgress"></div>
    
    <!-- Debug Info -->
    <div class="debug-info" id="debugInfo"></div>
    
    <div class="header" id="header">
        <div class="header-content">
            <div class="header-row">
                <div class="upload-container">
                    <input type="file" id="fileInput" class="file-input" accept=".pdf">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        üìÑ Carregar PDF
                    </button>
                    <span class="file-name" id="fileName"></span>
                </div>

                <div class="controls">
                    <div class="font-controls">
                        <button class="btn btn-secondary btn-small" onclick="decreaseFontSize()" title="Diminuir fonte">A-</button>
                        <span class="font-size-display" id="fontSizeDisplay">16px</span>
                        <button class="btn btn-secondary btn-small" onclick="increaseFontSize()" title="Aumentar fonte">A+</button>
                    </div>

                    <select id="fontFamilySelect" class="select" onchange="changeFontFamily()" title="Fam√≠lia da fonte">
                        <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Arial', Helvetica, sans-serif">Arial</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                    </select>

                    <button class="btn btn-secondary btn-small" onclick="resetFontSize()" title="Resetar fonte">üîÑ</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleFullscreen()" id="fullscreenBtn" title="Tela cheia">üî≥</button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleTheme()" id="themeToggle" title="Alternar tema">üåô</button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleTTSControls()" id="ttsToggle" style="display: none;" title="Controles de voz">üîä</button>
                </div>
            </div>

            <div class="tts-controls hidden" id="ttsControls">
                <div class="tts-row">
                    <div class="control-group">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <button class="btn" onclick="toggleReading()" id="playPauseBtn">
                            ‚ñ∂Ô∏è Reproduzir
                        </button>
                        <button class="btn btn-secondary" onclick="stopReading()">
                            ‚èπÔ∏è Parar
                        </button>
                        <button class="btn btn-secondary" onclick="readSelectedText()" id="readSelectionBtn" style="display: none;">
                            üìñ Ler Sele√ß√£o
                        </button>
                    </div>
                </div>

                <div class="tts-row">
                    <div class="control-group">
                        <label for="voiceSelect" class="text-small font-bold">Voz:</label>
                        <select id="voiceSelect" class="select" onchange="changeVoice()">
                            <option value="">Carregando vozes...</option>
                        </select>
                    </div>

                    <div class="slider-container">
                        <label class="text-small font-bold">Velocidade:</label>
                        <input type="range" id="rateSlider" class="slider" min="0.5" max="2" step="0.1" value="1" onchange="updateRate()">
                        <span id="rateValue" class="text-small">1.0</span>
                    </div>

                    <div class="slider-container">
                        <label class="text-small font-bold">Volume:</label>
                        <input type="range" id="volumeSlider" class="slider" min="0" max="1" step="0.1" value="1" onchange="updateVolume()">
                        <span id="volumeValue" class="text-small">100%</span>
                    </div>
                </div>

                <div class="selected-text-preview hidden" id="selectedTextPreview">
                    <div class="font-bold mb-2">Texto selecionado:</div>
                    <div id="selectedTextContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Controls for Fullscreen -->
    <div class="floating-controls" id="floatingControls">
        <button class="btn" onclick="toggleQuickPanel()" title="Painel r√°pido">‚öôÔ∏è</button>
        <button class="btn" onclick="handleFloatingPlayClick()" id="floatingPlayBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
        <button class="btn" onclick="exitFullscreen()" title="Sair da tela cheia">‚ùå</button>
    </div>

    <!-- Quick Access Panel -->
    <div class="quick-panel" id="quickPanel">
        <h3>Controles R√°pidos</h3>
        
        <div class="control-group">
            <button class="btn" onclick="handleQuickPlayClick()">
                <span id="quickPlayIcon">‚ñ∂Ô∏è</span> <span id="quickPlayText">Reproduzir</span>
            </button>
            <button class="btn btn-secondary" onclick="stopReading()">‚èπÔ∏è Parar</button>
        </div>

        <div class="control-group">
            <label>Fonte</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="btn btn-secondary" onclick="decreaseFontSize()" style="width: 40px;">A-</button>
                <span id="quickFontSize" style="color: white; min-width: 40px; text-align: center;">16px</span>
                <button class="btn btn-secondary" onclick="increaseFontSize()" style="width: 40px;">A+</button>
            </div>
        </div>

        <div class="control-group">
            <label for="quickVoiceSelect">Voz</label>
            <select id="quickVoiceSelect" class="select" onchange="changeVoiceFromQuick()" style="width: 100%;">
            </select>
        </div>

        <div class="control-group">
            <label for="quickRateSlider">Velocidade: <span id="quickRateValue">1.0</span></label>
            <input type="range" id="quickRateSlider" class="slider" min="0.5" max="2" step="0.1" value="1" onchange="updateRateFromQuick()" style="width: 100%;">
        </div>

        <div class="control-group">
            <label for="quickVolumeSlider">Volume: <span id="quickVolumeValue">100%</span></label>
            <input type="range" id="quickVolumeSlider" class="slider" min="0" max="1" step="0.1" value="1" onchange="updateVolumeFromQuick()" style="width: 100%;">
        </div>

        <div class="control-group">
            <button class="btn btn-secondary" onclick="toggleTheme()">
                <span id="quickThemeIcon">üåô</span> Alternar Tema
            </button>
            <button class="btn btn-secondary" onclick="resetFontSize()">üîÑ Reset Fonte</button>
        </div>

        <div class="control-group">
            <button class="btn btn-secondary" onclick="toggleDebugInfo()">üêõ Debug Info</button>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="upload-area" id="uploadArea">
            <div class="upload-text">
                <div class="upload-icon">üìÑ</div>
                <div>Arraste e solte um arquivo PDF aqui</div>
                <div>ou clique em "Carregar PDF"</div>
                <div style="margin-top: 15px; font-size: 14px;">O texto ser√° extra√≠do e formatado para leitura com s√≠ntese de voz</div>
            </div>
        </div>

        <div class="reader-container" id="readerContainer">
            <div class="loading hidden" id="loading">
                <div class="spinner"></div>
                <div>Extraindo texto do PDF...</div>
            </div>
            <div class="page-info" id="pageInfo"></div>
            <div class="reader-content" id="readerContent"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Vari√°veis globais
        let pdfDoc = null;
        let fontSize = 16;
        let currentFileName = '';
        let extractedText = '';
        let selectedText = '';
        let isReading = false;
        let isPaused = false;
        let currentUtterance = null;
        let availableVoices = [];
        let isFullscreenMode = false;
        let quickPanelOpen = false;
        let speechSynthesisReady = false;
        let userInteracted = false;
        let debugMode = false;

        // Configura√ß√µes TTS
        let ttsSettings = {
            rate: 1,
            pitch: 1,
            volume: 1,
            voice: ''
        };

        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const readerContainer = document.getElementById('readerContainer');
        const readerContent = document.getElementById('readerContent');
        const loading = document.getElementById('loading');
        const pageInfo = document.getElementById('pageInfo');
        const fileName = document.getElementById('fileName');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const readingProgress = document.getElementById('readingProgress');
        const header = document.getElementById('header');
        const mainContent = document.getElementById('mainContent');
        const ttsControls = document.getElementById('ttsControls');
        const ttsToggle = document.getElementById('ttsToggle');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateSlider = document.getElementById('rateSlider');
        const volumeSlider = document.getElementById('volumeSlider');
        const rateValue = document.getElementById('rateValue');
        const volumeValue = document.getElementById('volumeValue');
        const selectedTextPreview = document.getElementById('selectedTextPreview');
        const selectedTextContent = document.getElementById('selectedTextContent');
        const readSelectionBtn = document.getElementById('readSelectionBtn');
        const themeToggle = document.getElementById('themeToggle');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const floatingControls = document.getElementById('floatingControls');
        const quickPanel = document.getElementById('quickPanel');
        const floatingPlayBtn = document.getElementById('floatingPlayBtn');
        const debugInfo = document.getElementById('debugInfo');

        // Quick panel elements
        const quickFontSize = document.getElementById('quickFontSize');
        const quickVoiceSelect = document.getElementById('quickVoiceSelect');
        const quickRateSlider = document.getElementById('quickRateSlider');
        const quickVolumeSlider = document.getElementById('quickVolumeSlider');
        const quickRateValue = document.getElementById('quickRateValue');
        const quickVolumeValue = document.getElementById('quickVolumeValue');
        const quickPlayIcon = document.getElementById('quickPlayIcon');
        const quickPlayText = document.getElementById('quickPlayText');
        const quickThemeIcon = document.getElementById('quickThemeIcon');

        // Debug function
        function updateDebugInfo() {
            if (!debugMode) return;
            
            const info = {
                isFullscreen: isFullscreenMode,
                isReading: isReading,
                isPaused: isPaused,
                speechSynthesisReady: speechSynthesisReady,
                userInteracted: userInteracted,
                voicesCount: availableVoices.length,
                currentVoice: ttsSettings.voice,
                speechSynthesisState: {
                    speaking: speechSynthesis.speaking,
                    pending: speechSynthesis.pending,
                    paused: speechSynthesis.paused
                },
                extractedTextLength: extractedText.length,
                selectedTextLength: selectedText.length
            };
            
            debugInfo.innerHTML = Object.entries(info)
                .map(([key, value]) => `${key}: ${JSON.stringify(value)}`)
                .join('<br>');
        }

        function toggleDebugInfo() {
            debugMode = !debugMode;
            debugInfo.classList.toggle('show', debugMode);
            if (debugMode) {
                updateDebugInfo();
                setInterval(updateDebugInfo, 1000);
            }
        }

        // Detectar intera√ß√£o do usu√°rio
        function markUserInteraction() {
            if (!userInteracted) {
                userInteracted = true;
                updateDebugInfo();
                console.log('User interaction detected');
            }
        }

        // Event listeners para detectar intera√ß√£o
        ['click', 'touchstart', 'keydown'].forEach(event => {
            document.addEventListener(event, markUserInteraction, { once: true });
        });

        // Event listeners
        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('click', () => fileInput.click());
        readerContainer.addEventListener('scroll', updateReadingProgress);
        document.addEventListener('mouseup', handleTextSelection);
        document.addEventListener('keyup', handleTextSelection);
        document.addEventListener('keydown', handleKeyboardShortcuts);
        document.addEventListener('fullscreenchange', handleFullscreenChange);

        // Touch events for mobile
        let touchStartY = 0;
        let touchEndY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartY = e.changedTouches[0].screenY;
            markUserInteraction();
        });

        document.addEventListener('touchend', (e) => {
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartY - touchEndY;

            if (isFullscreenMode && Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe up - show floating controls
                    floatingControls.classList.add('show');
                    setTimeout(() => {
                        if (!quickPanelOpen) {
                            floatingControls.classList.remove('show');
                        }
                    }, 3000);
                }
            }
        }

        // Carregar vozes com retry
        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            
            if (voices.length > 0) {
                availableVoices = voices;
                speechSynthesisReady = true;
                populateVoiceSelect();
                populateQuickVoiceSelect();
                
                // Selecionar voz em portugu√™s por padr√£o
                if (!ttsSettings.voice) {
                    const portugueseVoice = availableVoices.find(voice => 
                        voice.lang.includes('pt') || voice.lang.includes('PT')
                    );
                    
                    if (portugueseVoice) {
                        ttsSettings.voice = portugueseVoice.name;
                        voiceSelect.value = portugueseVoice.name;
                        quickVoiceSelect.value = portugueseVoice.name;
                    } else if (availableVoices.length > 0) {
                        // Fallback para primeira voz dispon√≠vel
                        ttsSettings.voice = availableVoices[0].name;
                        voiceSelect.value = availableVoices[0].name;
                        quickVoiceSelect.value = availableVoices[0].name;
                    }
                }
                
                updateDebugInfo();
                console.log(`Loaded ${voices.length} voices, ready: ${speechSynthesisReady}`);
            } else {
                // Retry after a short delay
                setTimeout(loadVoices, 100);
            }
        }

        function populateVoiceSelect() {
            voiceSelect.innerHTML = '';
            availableVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
        }

        function populateQuickVoiceSelect() {
            quickVoiceSelect.innerHTML = '';
            availableVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                quickVoiceSelect.appendChild(option);
            });
        }

        // Carregar vozes quando dispon√≠veis
        speechSynthesis.addEventListener('voiceschanged', loadVoices);
        
        // Tentar carregar vozes imediatamente
        loadVoices();

        // Retry loading voices after page load
        window.addEventListener('load', () => {
            setTimeout(loadVoices, 500);
        });

        function handleFileSelect(event) {
            markUserInteraction();
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                loadPDF(file);
            } else {
                showError('Por favor, selecione um arquivo PDF v√°lido.');
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            markUserInteraction();
            uploadArea.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                loadPDF(files[0]);
            } else {
                showError('Por favor, arraste um arquivo PDF v√°lido.');
            }
        }

        async function loadPDF(file) {
            try {
                currentFileName = file.name;
                fileName.textContent = currentFileName;
                uploadArea.style.display = 'none';
                readerContainer.style.display = 'block';
                loading.classList.remove('hidden');
                readerContent.innerHTML = '';

                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                await extractAllText();
                
                loading.classList.add('hidden');
                pageInfo.textContent = `Texto extra√≠do de ${pdfDoc.numPages} p√°ginas`;
                ttsToggle.style.display = 'block';
                updateStatusIndicator('stopped');
                updateDebugInfo();
            } catch (error) {
                console.error('Erro ao carregar PDF:', error);
                showError('Erro ao carregar o arquivo PDF. Verifique se o arquivo n√£o est√° corrompido.');
                loading.classList.add('hidden');
            }
        }

        async function extractAllText() {
            let fullText = '';
            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                try {
                    const page = await pdfDoc.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    let pageText = '';
                    let lastY = null;

                    textContent.items.forEach((item, index) => {
                        if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                            pageText += '\n';
                        }
                        pageText += item.str;

                        if (index < textContent.items.length - 1) {
                            const nextItem = textContent.items[index + 1];
                            const currentX = item.transform[4] + item.width;
                            const nextX = nextItem.transform[4];
                            if (nextX - currentX > 1) {
                                pageText += ' ';
                            }
                        }
                        lastY = item.transform[5];
                    });

                    fullText += pageText + '\n\n';
                } catch (error) {
                    console.error(`Erro ao extrair texto da p√°gina ${pageNum}:`, error);
                    fullText += `[Erro ao extrair texto da p√°gina ${pageNum}]\n\n`;
                }
            }
            formatAndDisplayText(fullText);
        }

        function formatAndDisplayText(text) {
            const formattedText = text
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                .replace(/([.!?])\s*\n\s*([A-Z])/g, '$1\n\n$2')
                .replace(/\n([a-z])/g, ' $1')
                .trim();

            extractedText = formattedText;
            const paragraphs = formattedText.split(/\n\s*\n/);
            let htmlContent = '';

            paragraphs.forEach(paragraph => {
                paragraph = paragraph.trim();
                if (paragraph) {
                    if (paragraph.length < 100 && 
                        (paragraph === paragraph.toUpperCase() || /^[A-Z]/.test(paragraph))) {
                        htmlContent += `<h2>${paragraph}</h2>`;
                    } else {
                        htmlContent += `<p>${paragraph}</p>`;
                    }
                }
            });

            readerContent.innerHTML = htmlContent || '<p>N√£o foi poss√≠vel extrair texto leg√≠vel deste PDF.</p>';
            updateDebugInfo();
        }

        // Fun√ß√µes de controle de fonte
        function increaseFontSize() {
            if (fontSize < 32) {
                fontSize += 2;
                updateFontSize();
            }
        }

        function decreaseFontSize() {
            if (fontSize > 10) {
                fontSize -= 2;
                updateFontSize();
            }
        }

        function resetFontSize() {
            fontSize = 16;
            updateFontSize();
        }

        function updateFontSize() {
            readerContent.style.fontSize = fontSize + 'px';
            fontSizeDisplay.textContent = fontSize + 'px';
            quickFontSize.textContent = fontSize + 'px';
        }

        function changeFontFamily() {
            const fontFamily = document.getElementById('fontFamilySelect').value;
            readerContent.style.fontFamily = fontFamily;
        }

        // Fun√ß√µes de fullscreen
        function toggleFullscreen() {
            markUserInteraction();
            if (!document.fullscreenElement) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        }

        function enterFullscreen() {
            document.documentElement.requestFullscreen().catch(err => {
                console.error('Erro ao entrar em tela cheia:', err);
            });
        }

        function exitFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        function handleFullscreenChange() {
            isFullscreenMode = !!document.fullscreenElement;
            
            if (isFullscreenMode) {
                // Entrou em fullscreen
                document.body.classList.add('fullscreen-mode');
                header.classList.add('fullscreen-hidden');
                mainContent.classList.add('fullscreen');
                readerContainer.classList.add('fullscreen');
                readerContent.classList.add('fullscreen');
                pageInfo.classList.add('fullscreen');
                fullscreenBtn.innerHTML = 'üî≤ Sair';
                
                // Mostrar controles flutuantes
                floatingControls.classList.add('show');
                
                // Esconder controles ap√≥s 3 segundos
                setTimeout(() => {
                    if (!quickPanelOpen) {
                        floatingControls.classList.remove('show');
                    }
                }, 3000);
                
            } else {
                // Saiu do fullscreen
                document.body.classList.remove('fullscreen-mode');
                header.classList.remove('fullscreen-hidden');
                mainContent.classList.remove('fullscreen');
                readerContainer.classList.remove('fullscreen');
                readerContent.classList.remove('fullscreen');
                pageInfo.classList.remove('fullscreen');
                fullscreenBtn.innerHTML = 'üî≥ Tela Cheia';
                
                // Esconder controles flutuantes
                floatingControls.classList.remove('show');
                quickPanel.classList.remove('show');
                quickPanelOpen = false;
            }
            
            updateDebugInfo();
        }

        // Fun√ß√µes TTS melhoradas
        function toggleTTSControls() {
            ttsControls.classList.toggle('hidden');
        }

        function ensureSpeechSynthesisReady() {
            return new Promise((resolve) => {
                if (speechSynthesisReady && availableVoices.length > 0) {
                    resolve(true);
                    return;
                }
                
                // Tentar carregar vozes novamente
                loadVoices();
                
                // Aguardar um pouco e tentar novamente
                setTimeout(() => {
                    if (speechSynthesisReady && availableVoices.length > 0) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                }, 500);
            });
        }

        async function startReading(text) {
            markUserInteraction();
            
            if (!('speechSynthesis' in window)) {
                showError('Seu navegador n√£o suporta s√≠ntese de voz.');
                return;
            }

            if (!userInteracted) {
                showError('Clique em qualquer lugar da tela primeiro para ativar o √°udio.');
                return;
            }

            const textToRead = text || selectedText || extractedText;
            if (!textToRead) {
                showError('Nenhum texto dispon√≠vel para leitura.');
                return;
            }

            // Garantir que o speech synthesis est√° pronto
            const ready = await ensureSpeechSynthesisReady();
            if (!ready) {
                showError('Sistema de voz n√£o est√° pronto. Tente novamente em alguns segundos.');
                return;
            }

            // Parar qualquer reprodu√ß√£o anterior
            stopReading();

            try {
                currentUtterance = new SpeechSynthesisUtterance(textToRead);
                
                // Configurar voz
                const selectedVoice = availableVoices.find(voice => voice.name === ttsSettings.voice);
                if (selectedVoice) {
                    currentUtterance.voice = selectedVoice;
                    console.log('Using voice:', selectedVoice.name);
                } else {
                    console.log('Voice not found, using default');
                }

                currentUtterance.rate = ttsSettings.rate;
                currentUtterance.pitch = ttsSettings.pitch;
                currentUtterance.volume = ttsSettings.volume;

                currentUtterance.onstart = () => {
                    console.log('Speech started');
                    isReading = true;
                    isPaused = false;
                    updatePlayPauseButton();
                    updateStatusIndicator('reading');
                    updateDebugInfo();
                };

                currentUtterance.onend = () => {
                    console.log('Speech ended');
                    isReading = false;
                    isPaused = false;
                    updatePlayPauseButton();
                    updateStatusIndicator('stopped');
                    updateDebugInfo();
                };

                currentUtterance.onerror = (event) => {
                    console.error('Speech error:', event);
                    showError(`Erro na s√≠ntese de voz: ${event.error}`);
                    isReading = false;
                    isPaused = false;
                    updatePlayPauseButton();
                    updateStatusIndicator('stopped');
                    updateDebugInfo();
                };

                currentUtterance.onpause = () => {
                    console.log('Speech paused');
                    isPaused = true;
                    updatePlayPauseButton();
                    updateStatusIndicator('paused');
                    updateDebugInfo();
                };

                currentUtterance.onresume = () => {
                    console.log('Speech resumed');
                    isPaused = false;
                    updatePlayPauseButton();
                    updateStatusIndicator('reading');
                    updateDebugInfo();
                };

                console.log('Starting speech synthesis...');
                speechSynthesis.speak(currentUtterance);
                
                // Verificar se realmente come√ßou
                setTimeout(() => {
                    if (!speechSynthesis.speaking && !speechSynthesis.pending) {
                        console.error('Speech synthesis failed to start');
                        showError('Falha ao iniciar a s√≠ntese de voz. Tente novamente.');
                        isReading = false;
                        updatePlayPauseButton();
                        updateStatusIndicator('stopped');
                    }
                    updateDebugInfo();
                }, 100);
                
            } catch (error) {
                console.error('Error starting speech:', error);
                showError('Erro ao iniciar a reprodu√ß√£o de √°udio.');
                isReading = false;
                updatePlayPauseButton();
                updateStatusIndicator('stopped');
                updateDebugInfo();
            }
        }

        function pauseReading() {
            if (speechSynthesis.speaking && !speechSynthesis.paused) {
                speechSynthesis.pause();
                // O evento onpause vai atualizar o estado
            }
        }

        function resumeReading() {
            if (speechSynthesis.paused) {
                speechSynthesis.resume();
                // O evento onresume vai atualizar o estado
            }
        }

        function stopReading() {
            speechSynthesis.cancel();
            isReading = false;
            isPaused = false;
            updatePlayPauseButton();
            updateStatusIndicator('stopped');
            updateDebugInfo();
        }

        function toggleReading() {
            markUserInteraction();
            if (isReading) {
                if (isPaused) {
                    resumeReading();
                } else {
                    pauseReading();
                }
            } else {
                startReading();
            }
        }

        // Handlers espec√≠ficos para controles flutuantes
        function handleFloatingPlayClick() {
            markUserInteraction();
            toggleReading();
        }

        function handleQuickPlayClick() {
            markUserInteraction();
            toggleReading();
        }

        function readSelectedText() {
            if (selectedText) {
                startReading(selectedText);
            }
        }

        function updatePlayPauseButton() {
            const icon = isReading && !isPaused ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            const text = isReading && !isPaused ? 'Pausar' : 'Reproduzir';
            
            playPauseBtn.innerHTML = `${icon} ${text}`;
            floatingPlayBtn.innerHTML = icon;
            quickPlayIcon.textContent = icon;
            quickPlayText.textContent = text;
        }

        function updateStatusIndicator(status) {
            statusIndicator.className = 'status-indicator';
            switch (status) {
                case 'reading':
                    statusIndicator.classList.add('status-reading');
                    break;
                case 'paused':
                    statusIndicator.classList.add('status-paused');
                    break;
                default:
                    statusIndicator.classList.add('status-stopped');
            }
        }

        // Quick Panel Functions
        function toggleQuickPanel() {
            quickPanelOpen = !quickPanelOpen;
            quickPanel.classList.toggle('show');
            
            if (quickPanelOpen) {
                floatingControls.classList.add('show');
                syncQuickPanelValues();
            } else if (!isFullscreenMode) {
                floatingControls.classList.remove('show');
            }
        }

        function syncQuickPanelValues() {
            quickFontSize.textContent = fontSize + 'px';
            quickVoiceSelect.value = ttsSettings.voice;
            quickRateSlider.value = ttsSettings.rate;
            quickVolumeSlider.value = ttsSettings.volume;
            quickRateValue.textContent = ttsSettings.rate.toFixed(1);
            quickVolumeValue.textContent = Math.round(ttsSettings.volume * 100) + '%';
        }

        function changeVoiceFromQuick() {
            ttsSettings.voice = quickVoiceSelect.value;
            voiceSelect.value = ttsSettings.voice;
            updateDebugInfo();
        }

        function updateRateFromQuick() {
            ttsSettings.rate = parseFloat(quickRateSlider.value);
            quickRateValue.textContent = ttsSettings.rate.toFixed(1);
            rateSlider.value = ttsSettings.rate;
            rateValue.textContent = ttsSettings.rate.toFixed(1);
        }

        function updateVolumeFromQuick() {
            ttsSettings.volume = parseFloat(quickVolumeSlider.value);
            quickVolumeValue.textContent = Math.round(ttsSettings.volume * 100) + '%';
            volumeSlider.value = ttsSettings.volume;
            volumeValue.textContent = Math.round(ttsSettings.volume * 100) + '%';
        }

        // Configura√ß√µes TTS
        function changeVoice() {
            ttsSettings.voice = voiceSelect.value;
            quickVoiceSelect.value = ttsSettings.voice;
            updateDebugInfo();
        }

        function updateRate() {
            ttsSettings.rate = parseFloat(rateSlider.value);
            rateValue.textContent = ttsSettings.rate.toFixed(1);
            quickRateSlider.value = ttsSettings.rate;
            quickRateValue.textContent = ttsSettings.rate.toFixed(1);
        }

        function updateVolume() {
            ttsSettings.volume = parseFloat(volumeSlider.value);
            volumeValue.textContent = Math.round(ttsSettings.volume * 100) + '%';
            quickVolumeSlider.value = ttsSettings.volume;
            quickVolumeValue.textContent = Math.round(ttsSettings.volume * 100) + '%';
        }

        // Sele√ß√£o de texto
        function handleTextSelection() {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            
            if (text && text !== selectedText) {
                selectedText = text;
                selectedTextContent.textContent = text.length > 100 ? text.substring(0, 100) + '...' : text;
                selectedTextPreview.classList.remove('hidden');
                readSelectionBtn.style.display = 'inline-flex';
            } else if (!text) {
                selectedText = '';
                selectedTextPreview.classList.add('hidden');
                readSelectionBtn.style.display = 'none';
            }
            updateDebugInfo();
        }

        // Outras fun√ß√µes
        function updateReadingProgress() {
            const container = readerContainer;
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight - container.clientHeight;
            const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            readingProgress.style.width = Math.min(100, Math.max(0, progress)) + '%';
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            const icon = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            themeToggle.textContent = icon;
            quickThemeIcon.textContent = icon;
        }

        function handleKeyboardShortcuts(event) {
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case '=':
                    case '+':
                        event.preventDefault();
                        increaseFontSize();
                        break;
                    case '-':
                        event.preventDefault();
                        decreaseFontSize();
                        break;
                    case '0':
                        event.preventDefault();
                        resetFontSize();
                        break;
                    case ' ':
                        event.preventDefault();
                        toggleReading();
                        break;
                }
            }

            if (event.key === 'F11') {
                event.preventDefault();
                toggleFullscreen();
            }

            if (event.key === 'Escape' && isFullscreenMode) {
                if (quickPanelOpen) {
                    toggleQuickPanel();
                } else {
                    exitFullscreen();
                }
            }
        }

        function showError(message) {
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Remover classe dragover quando sair da √°rea
        uploadArea.addEventListener('dragleave', (event) => {
            if (!uploadArea.contains(event.relatedTarget)) {
                uploadArea.classList.remove('dragover');
            }
        });

        // Fechar quick panel ao clicar fora
        document.addEventListener('click', (event) => {
            if (quickPanelOpen && !quickPanel.contains(event.target) && !floatingControls.contains(event.target)) {
                toggleQuickPanel();
            }
        });

        // Inicializa√ß√£o
        updateStatusIndicator('stopped');
        updatePlayPauseButton();
        syncQuickPanelValues();

        // Auto-hide floating controls in fullscreen
        let hideControlsTimeout;
        
        function showFloatingControls() {
            if (isFullscreenMode) {
                floatingControls.classList.add('show');
                clearTimeout(hideControlsTimeout);
                
                if (!quickPanelOpen) {
                    hideControlsTimeout = setTimeout(() => {
                        floatingControls.classList.remove('show');
                    }, 3000);
                }
            }
        }

        // Show controls on mouse movement in fullscreen
        document.addEventListener('mousemove', showFloatingControls);
        document.addEventListener('touchstart', showFloatingControls);

        // For√ßar carregamento de vozes em dispositivos m√≥veis
        function forceMobileVoiceLoad() {
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Criar uma utterance vazia para for√ßar o carregamento das vozes
                const testUtterance = new SpeechSynthesisUtterance('');
                testUtterance.volume = 0;
                speechSynthesis.speak(testUtterance);
                speechSynthesis.cancel();
                
                setTimeout(() => {
                    loadVoices();
                }, 100);
            }
        }

        // Executar ap√≥s intera√ß√£o do usu√°rio
        document.addEventListener('click', forceMobileVoiceLoad, { once: true });
        document.addEventListener('touchstart', forceMobileVoiceLoad, { once: true });

        // Verifica√ß√£o peri√≥dica do estado do speech synthesis
        setInterval(() => {
            if (isReading && !speechSynthesis.speaking && !speechSynthesis.pending) {
                console.log('Speech synthesis stopped unexpectedly');
                isReading = false;
                isPaused = false;
                updatePlayPauseButton();
                updateStatusIndicator('stopped');
                updateDebugInfo();
            }
        }, 1000);

        // Preven√ß√£o de sleep em dispositivos m√≥veis durante reprodu√ß√£o
        let wakeLock = null;

        async function requestWakeLock() {
            if ('wakeLock' in navigator && isReading) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock acquired');
                } catch (err) {
                    console.log('Wake lock failed:', err);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake lock released');
            }
        }

        // Aplicar wake lock quando come√ßar a ler
        const originalStartReading = startReading;
        startReading = async function(text) {
            await originalStartReading.call(this, text);
            if (isReading) {
                requestWakeLock();
            }
        };

        // Liberar wake lock quando parar
        const originalStopReading = stopReading;
        stopReading = function() {
            originalStopReading.call(this);
            releaseWakeLock();
        };

        // Liberar wake lock quando a p√°gina for escondida
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                releaseWakeLock();
            } else if (isReading) {
                requestWakeLock();
            }
        });
    </script>
</body>
</html>
